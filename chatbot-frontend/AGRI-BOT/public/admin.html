<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AgriUpdates — Admin Review</title>
  <style>
    body { font-family: system-ui, Arial; padding: 18px; background:#f6f7fb; color:#111 }
    .card{ background:#fff; border-radius:8px; padding:12px; margin:10px 0; box-shadow:0 2px 6px rgba(20,20,40,0.06) }
    .meta{ color:#666; font-size:13px }
    button{ margin-right:8px; padding:6px 10px; border:0; background:#2563eb; color:#fff; border-radius:6px; cursor:pointer }
    .reject{ background:#ef4444 }
  </style>
</head>
<body>
  <h2>Pending Scheme Updates</h2>
  <p>Enter admin JWT (generate on server) to load and approve updates.</p>
  <div>
    <input id="token" placeholder="Paste admin token here" style="width:60%; padding:8px" />
    <button id="load">Load</button>
  </div>
  <div id="list" style="margin-top:18px">No data loaded.</div>

<script>
const API = location.origin.replace(/:[0-9]+$/, ':4000'); // assumes server on localhost:4000
async function loadPending() {
  const token = document.getElementById('token').value.trim();
  if(!token){ alert('Paste admin token'); return; }
  const res = await fetch(API + '/v1/admin/updates', { headers: { Authorization: 'Bearer ' + token }});
  if(!res.ok){ alert('Failed to load: ' + res.status); return; }
  const data = await res.json();
  const list = document.getElementById('list');
  list.innerHTML = '';
  if(!data.results.length){ list.innerHTML = '<div class="card">No pending updates</div>'; return; }
  data.results.forEach(u => {
    const d = document.createElement('div'); d.className = 'card';
    d.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">${u.summary}</div>
          <div class="meta">${u.source?.source_url || ''} • ${u.severity} • ${new Date(u.createdAt).toLocaleString()}</div>
        </div>
        <div>
          <button class="approve" data-id="${u._id}">Approve</button>
          <button class="reject" data-id="${u._id}" style="background:#ef4444">Reject</button>
        </div>
      </div>
      <div style="margin-top:12px; color:#333">${u.details ? u.details.substring(0,800) : ''}</div>
    `;
    list.appendChild(d);
  });

  document.querySelectorAll('.approve').forEach(b => b.onclick = async (e) => {
    const id = e.target.dataset.id;
    const token = document.getElementById('token').value.trim();
    const r = await fetch(API + '/v1/approve/' + id, { method:'POST', headers: { Authorization: 'Bearer ' + token } });
    if(r.ok){ loadPending(); } else { alert('Approve failed: ' + r.status); }
  });
  document.querySelectorAll('.reject').forEach(b => b.onclick = async (e) => {
    const id = e.target.dataset.id;
    const token = document.getElementById('token').value.trim();
    const r = await fetch(API + '/v1/reject/' + id, { method:'POST', headers: { Authorization: 'Bearer ' + token, 'Content-Type':'application/json' }, body: JSON.stringify({ reason: 'Rejected via UI' }) });
    if(r.ok){ loadPending(); } else { alert('Reject failed: ' + r.status); }
  });
}

document.getElementById('load').onclick = loadPending;
</script>
</body>
</html>
